<html>

<head>
    <title>Container - UIkit</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://getuikit.com/css/theme.css?1333">
    <script type="text/javascript" async="" src="https://www.google-analytics.com/analytics.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/he/1.2.0/he.min.js" defer=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.6.2/marked.min.js" defer=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.11/vue.min.js" defer=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-router/3.1.3/vue-router.min.js" defer=""></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.5.9/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.5.9/dist/js/uikit-icons.min.js"></script>
    <script src="https://www.googletagmanager.com/gtag/js?id=UA-42150424-1" async=""></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script data-ad-client="ca-pub-9862173367747325" async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>

<body>
    <div class="uk-hieght-medium">
        <div uk-sticky="sel-target: .uk-navbar-container; cls-active: uk-navbar-sticky">
            <nav class="uk-navbar-container" uk-navbar>
                <div class="uk-navbar-center">
                    <ul class="uk-navbar-nav">
                        <li><a href="">UIKIT</a></li>
                    </ul>
                </div>
            </nav>
        </div>
        <div class="uk-card-body">
            <canvas class="uk-align-center" id="targetCanvas" width="540" height="860"></canvas>
        </div>
    </div>
</body>
<script>
    var sources = [];

    $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        var username = urlParams.get('u');
        $.ajax({
            url: 'http://54.187.219.232/v1/ig/' + username,
            processData: false,
            contentType: false,
            type: 'GET',
            success: function (resp) {
                if (resp.code != 0) {
                    return;
                }
                length = resp.data.post_list.length;
                if (length == 0) {
                    return;
                }

                for (i = 0; i < length; i++) {
                    sources[i] = resp.data.post_list[i].url;

                }
                show_preview_crop();
            }
        });


    })
    function loadImages(sources, callback) {
        var images = [];
        var loadedImages = 0;
        var numImages = 0;
        // get num of sources
        for (var src in sources) {
            numImages++;
        }
        for (i = 0; i < sources.length; i++) {
            images[i] = new Image();

            images[i].onload = function () {
                if (++loadedImages >= numImages) {
                    callback(images);
                }
            };
            images[i].src = sources[i];
        }
    }


    var canvas = document.getElementById('targetCanvas');
    var context = canvas.getContext('2d');

    function drawRectanlesBorders(img, x, y, width, height, deg) {

        var c = document.getElementById("targetCanvas");
        var ctx = c.getContext("2d");
        var rad = deg * Math.PI / 180;

        ctx.save();
        ctx.translate(x + width / 2, y + height / 2);
        ctx.rotate(rad);
        ctx.beginPath();
        ctx.rect(width / 2 * (-1), height / 2 * (-1), width, height);
        ctx.lineWidth = 5;
        ctx.strokeStyle = 'white';
        ctx.stroke();
        ctx.restore();
    }


    function drawImageRot_scale(img, x, y, image_width, img_height) {//crop_size, grid_width) {

        var c = document.getElementById("targetCanvas");
        var ctx = c.getContext("2d");

        console.log(x, y, image_width, img_height);
        ctx.drawImage(img, x, y, image_width, img_height);
        ctx.restore();
    }

    function show_preview_scale() {
        loadImages(sources, function (images) {
            var c = document.getElementById("targetCanvas");

            rowSize = Math.ceil(Math.sqrt(sources.length));
            console.log(rowSize);
            width = Math.floor(540 / rowSize);
            height = width;
            padding = 3;
            grid_width = width - (rowSize * padding);
            grid_height = grid_width;
            x_padding = padding;
            y_padding = padding;
            for (i = 0; i < sources.length; i++) {
                y = (grid_width + y_padding) * Math.floor(i / rowSize)
                x = (x_padding + grid_width) * (i % rowSize);

                drawRectanlesBorders(sources[i], x, y, grid_width, grid_height, 0);

                if (images[i].width > images[i].height) {
                    img_width = grid_width;
                    img_height = Math.floor(images[i].height * (grid_width / images[i].width))
                } else {
                    img_height = grid_width;
                    img_width = Math.floor(images[i].width * (grid_width / images[i].height))
                }

                if (img_width < grid_width) {
                    x += (grid_width - img_width) / 2;
                }
                if (img_height < grid_height) {
                    y += (grid_height - img_height) / 2;
                }
                drawImageRot_scale(images[i], x, y, img_width, img_height);
            }
        });
    }
    function drawImageRot_crop(img, x, y, crop_size, grid_width) {

        var c = document.getElementById("targetCanvas");
        var ctx = c.getContext("2d");

        console.log(0, 0, crop_size, crop_size, x, y, grid_width, grid_width);
        ctx.drawImage(img, 0, 0, crop_size, crop_size, x, y, grid_width, grid_width);
        ctx.restore();
    }

    function show_preview_crop() {
        loadImages(sources, function (images) {
            var c = document.getElementById("targetCanvas");

            rowSize = Math.ceil(Math.sqrt(sources.length));
            console.log(rowSize);
            width = Math.floor(540 / rowSize);
            height = width;
            padding = 3;
            grid_width = width - (rowSize * padding);
            grid_height = grid_width;
            x_padding = padding;
            y_padding = padding;
            for (i = 0; i < sources.length; i++) {
                y = (grid_width + y_padding) * Math.floor(i / rowSize)
                x = (x_padding + grid_width) * (i % rowSize);

                drawRectanlesBorders(sources[i], x, y, grid_width, grid_height, 0);

                crop_size = images[i].width;
                if (images[i].width > images[i].height) {
                    crop_size = images[i].height;
                }
                drawImageRot_crop(images[i], x, y, crop_size, grid_width);


            }
        });
    }

</script>

</html>